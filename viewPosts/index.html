<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blog API Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .form-container {
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 5px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #45a049;
      }
      .error {
        color: red;
        margin-top: 10px;
      }
      .success {
        color: green;
        margin-top: 10px;
      }
      .hidden {
        display: none;
      }
      #posts-container {
        margin-top: 20px;
      }
      .post {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
      }
      .post h3 {
        margin-top: 0;
      }
      .post-actions {
        margin-top: 10px;
      }
      nav {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      nav a {
        text-decoration: none;
        color: #333;
        padding: 5px 10px;
      }
      nav a:hover {
        background-color: #f5f5f5;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Blog API Test</h1>

      <nav>
        <a href="#" id="home-link">Home</a>
        <a href="#" id="register-link">Register</a>
        <a href="#" id="login-link">Login</a>
        <a href="#" id="posts-link" class="hidden">Posts</a>
        <a href="#" id="logout-link" class="hidden">Logout</a>
      </nav>

      <div id="register-container" class="form-container hidden">
        <h2>Register</h2>
        <form id="register-form">
          <div class="form-group">
            <label for="register-email">Email:</label>
            <input type="email" id="register-email" required />
          </div>
          <div class="form-group">
            <label for="register-username">Username:</label>
            <input type="text" id="register-username" required />
          </div>
          <div class="form-group">
            <label for="register-password">Password:</label>
            <input type="password" id="register-password" required />
          </div>
          <button type="submit">Register</button>
        </form>
        <div id="register-error" class="error"></div>
        <div id="register-success" class="success"></div>
      </div>

      <div id="login-container" class="form-container hidden">
        <h2>Login</h2>
        <form id="login-form">
          <div class="form-group">
            <label for="login-username">Username:</label>
            <input type="text" id="login-username" required />
          </div>
          <div class="form-group">
            <label for="login-password">Password:</label>
            <input type="password" id="login-password" required />
          </div>
          <button type="submit">Login</button>
        </form>
        <div id="login-error" class="error"></div>
      </div>

      <div id="posts-container" class="hidden">
        <h2>Posts</h2>
        <button id="create-post-btn">Create New Post</button>

        <div id="create-post-form" class="form-container hidden">
          <h3>Create Post</h3>
          <form id="new-post-form">
            <div class="form-group">
              <label for="post-title">Title:</label>
              <input type="text" id="post-title" required />
            </div>
            <div class="form-group">
              <label for="post-content">Content:</label>
              <input type="text" id="post-content" required />
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="post-published" /> Published
              </label>
            </div>
            <button type="submit">Create</button>
            <button type="button" id="cancel-create">Cancel</button>
          </form>
          <div id="post-error" class="error"></div>
        </div>

        <div id="posts-list"></div>
      </div>

      <div id="home-container">
        <h2>Welcome to the Blog API Test</h2>
        <p>Please register or login to access posts functionality.</p>
        <div id="auth-status"></div>
      </div>
    </div>

    <script>
      // Base API URL - adjust this to match your backend URL
      const API_BASE_URL = "http://localhost:3000"; // Change if your backend runs on a different port

      // DOM elements
      const registerLink = document.getElementById("register-link");
      const loginLink = document.getElementById("login-link");
      const postsLink = document.getElementById("posts-link");
      const logoutLink = document.getElementById("logout-link");
      const homeLink = document.getElementById("home-link");

      const registerContainer = document.getElementById("register-container");
      const loginContainer = document.getElementById("login-container");
      const postsContainer = document.getElementById("posts-container");
      const homeContainer = document.getElementById("home-container");

      const registerForm = document.getElementById("register-form");
      const loginForm = document.getElementById("login-form");

      const authStatus = document.getElementById("auth-status");

      // JWT token storage
      let token = localStorage.getItem("jwtToken");
      let currentUser = null;

      // Navigation
      function showSection(section) {
        registerContainer.classList.add("hidden");
        loginContainer.classList.add("hidden");
        postsContainer.classList.add("hidden");
        homeContainer.classList.add("hidden");

        section.classList.remove("hidden");
      }

      registerLink.addEventListener("click", (e) => {
        e.preventDefault();
        showSection(registerContainer);
      });

      loginLink.addEventListener("click", (e) => {
        e.preventDefault();
        showSection(loginContainer);
      });

      postsLink.addEventListener("click", (e) => {
        e.preventDefault();
        showSection(postsContainer);
        loadPosts();
      });

      logoutLink.addEventListener("click", (e) => {
        e.preventDefault();
        logout();
      });

      homeLink.addEventListener("click", (e) => {
        e.preventDefault();
        showSection(homeContainer);
      });

      // Check auth status on page load
      function checkAuth() {
        if (token) {
          // Verify token is still valid
          fetch(`${API_BASE_URL}/auth/verify`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((response) => {
              if (response.ok) {
                return response.json();
              } else {
                throw new Error("Token invalid");
              }
            })
            .then((data) => {
              currentUser = data.user;
              updateAuthUI(true);
              showSection(postsContainer);
              loadPosts();
            })
            .catch((error) => {
              console.error("Token verification failed:", error);
              logout();
            });
        } else {
          updateAuthUI(false);
          showSection(homeContainer);
        }
      }

      // Update UI based on auth status
      function updateAuthUI(isAuthenticated) {
        if (isAuthenticated) {
          registerLink.classList.add("hidden");
          loginLink.classList.add("hidden");
          postsLink.classList.remove("hidden");
          logoutLink.classList.remove("hidden");
          authStatus.innerHTML = `Logged in as ${currentUser.username}`;
        } else {
          registerLink.classList.remove("hidden");
          loginLink.classList.remove("hidden");
          postsLink.classList.add("hidden");
          logoutLink.classList.add("hidden");
          authStatus.innerHTML = "Not logged in";
        }
      }

      // Register form submission
      registerForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const email = document.getElementById("register-email").value;
        const username = document.getElementById("register-username").value;
        const password = document.getElementById("register-password").value;

        fetch(`${API_BASE_URL}/auth/register`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ email, username, password }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              document.getElementById("register-error").textContent =
                data.error;
              document.getElementById("register-success").textContent = "";
            } else {
              document.getElementById("register-error").textContent = "";
              document.getElementById("register-success").textContent =
                "Registration successful! Please login.";
              registerForm.reset();
              showSection(loginContainer);
            }
          })
          .catch((error) => {
            document.getElementById("register-error").textContent =
              "Registration failed. Please try again.";
            console.error("Registration error:", error);
          });
      });

      // Login form submission
      loginForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;

        fetch(`${API_BASE_URL}/auth/login`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ username, password }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.token) {
              token = data.token;
              localStorage.setItem("jwtToken", token);
              currentUser = { username }; // In a real app, you might get more user data
              updateAuthUI(true);
              showSection(postsContainer);
              loadPosts();
              loginForm.reset();
            } else {
              document.getElementById("login-error").textContent =
                data.message || "Login failed";
            }
          })
          .catch((error) => {
            document.getElementById("login-error").textContent =
              "Login failed. Please try again.";
            console.error("Login error:", error);
          });
      });

      // Logout function
      function logout() {
        token = null;
        currentUser = null;
        localStorage.removeItem("jwtToken");
        updateAuthUI(false);
        showSection(homeContainer);
      }

      // Posts functionality
      const createPostBtn = document.getElementById("create-post-btn");
      const createPostForm = document.getElementById("create-post-form");
      const newPostForm = document.getElementById("new-post-form");
      const cancelCreateBtn = document.getElementById("cancel-create");
      const postsList = document.getElementById("posts-list");

      createPostBtn.addEventListener("click", () => {
        createPostForm.classList.remove("hidden");
      });

      cancelCreateBtn.addEventListener("click", () => {
        createPostForm.classList.add("hidden");
        newPostForm.reset();
      });

      newPostForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const title = document.getElementById("post-title").value;
        const content = document.getElementById("post-content").value;
        const published = document.getElementById("post-published").checked;

        fetch(`${API_BASE_URL}/posts`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ title, content, published }),
        })
          .then((response) => response.json())
          .then((post) => {
            createPostForm.classList.add("hidden");
            newPostForm.reset();
            loadPosts();
          })
          .catch((error) => {
            document.getElementById("post-error").textContent =
              "Failed to create post";
            console.error("Post creation error:", error);
          });
      });

      function loadPosts() {
        fetch(`${API_BASE_URL}/posts`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((response) => response.json())
          .then((posts) => {
            postsList.innerHTML = "";

            if (posts.length === 0) {
              postsList.innerHTML = "<p>No posts found.</p>";
              return;
            }

            posts.forEach((post) => {
              const postEl = document.createElement("div");
              postEl.className = "post";
              postEl.innerHTML = `
                        <h3>${post.title}</h3>
                        <p>${post.content}</p>
                        <p>Status: ${post.published ? "Published" : "Draft"}</p>
                        <div class="post-actions">
                            <button class="edit-post" data-id="${
                              post.id
                            }">Edit</button>
                            <button class="delete-post" data-id="${
                              post.id
                            }">Delete</button>
                        </div>
                    `;
              postsList.appendChild(postEl);
            });

            // Add event listeners to edit and delete buttons
            document.querySelectorAll(".edit-post").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                const postId = e.target.getAttribute("data-id");
                editPost(postId);
              });
            });

            document.querySelectorAll(".delete-post").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                const postId = e.target.getAttribute("data-id");
                deletePost(postId);
              });
            });
          })
          .catch((error) => {
            console.error("Error loading posts:", error);
            postsList.innerHTML = "<p>Error loading posts.</p>";
          });
      }

      function editPost(postId) {
        // In a real app, you'd fetch the post and show an edit form
        alert(
          `Edit post ${postId} - functionality not implemented in this demo`
        );
      }

      function deletePost(postId) {
        if (confirm("Are you sure you want to delete this post?")) {
          fetch(`${API_BASE_URL}/posts/${postId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          })
            .then((response) => {
              if (response.ok) {
                loadPosts();
              } else {
                throw new Error("Delete failed");
              }
            })
            .catch((error) => {
              console.error("Delete error:", error);
              alert("Failed to delete post");
            });
        }
      }

      // Initialize the app
      checkAuth();
    </script>
  </body>
</html>
